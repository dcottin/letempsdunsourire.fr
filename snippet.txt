            templates,
            replacements,
            defaultName,
            signingLink
        };
    }, [emailType, statusSettings, form.watch(), internalMode, initialData])

    return (
        <Form {...form}>
            <form onSubmit={form.handleSubmit((data) => onSubmit(data, false), (err) => console.error("Form Submit Validation Errors:", JSON.stringify(err, null, 2)))} className="space-y-6">
                <div className="bg-slate-50 p-1.5 rounded-xl border-2 border-slate-100 shadow-sm mb-6 no-print">
    // Remove the useEffect auto-save that was causing loops/race conditions
    
    const handleModeSwitch = (newMode: "devis" | "contrat") => {
                        // 1. Update visual mode immediately
                        setInternalMode(newMode)

        // 2. Trigger auto-save logic
        // We use setTimeout to allow state to settle, though handleSubmit uses current form values.
        // Crucially, onSubmit will read internalMode. Since setState is async, we need to be careful.
        // However, form.handleSubmit captures values. onSubmit uses internalMode state.
        // To be safe, we'll wait a tick.
        setTimeout(() => {
                        form.handleSubmit((data) => onSubmit(data, true))()
                    }, 0)
    }

                    return (
                    <Form {...form}>
                        <form onSubmit={form.handleSubmit((data) => onSubmit(data, false), (err) => console.error("Form Submit Validation Errors:", JSON.stringify(err, null, 2)))} className="space-y-6">
                            <div className="bg-slate-50 p-1.5 rounded-xl border-2 border-slate-100 shadow-sm mb-6 no-print">
                                <Tabs value={internalMode} onValueChange={(v) => handleModeSwitch(v as any)} className="w-full">
                                    <TabsList className="grid grid-cols-2 w-full h-12 bg-transparent gap-2">
                                        <TabsTrigger
                                            value="devis"
                                            className="rounded-lg data-[state=active]:bg-white data-[state=active]:text-indigo-600 data-[state=active]:shadow-md font-bold transition-all gap-2 h-full"
                                        >
                                            <FileTextIcon className="size-4" /> DEVIS
                                        </TabsTrigger>
                                        <TabsTrigger
                                            value="contrat"
